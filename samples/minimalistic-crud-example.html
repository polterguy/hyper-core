<!DOCTYPE html>
<html>
  <head>
    <title>A CRUD database example!</title>
  </head>
  <body>
    <h1>CRUD example</h1>
    <ul id="names"></ul>
    <button onclick="login ();return false;">Login</button>
    <button onclick="logout ();return false;">Logout</button>
    <button onclick="insert_item ();return false;">Insert</button>
    <script>



/*
 * Asking user to provide his username and password, before invoking login module.
 */
function login () {

  /*
   * Retrieving username/password from user.
   */
  var username = prompt('Username');
  var password = prompt('Password');

  /*
   *Creating and decorating our HTTP request.
   */
  var xhr = new XMLHttpRequest();
  xhr.open('POST', '/hyper-core/login', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {

      /*
       * Checking if this was a success or not.
       */
      if (xhr.status != 200) {
        alert(xhr.responseText);
        return;
      }
      eval("window.res = " + xhr.responseText);
      alert('You belong to the role of; ' + window.res.role);
      get_items ();
    }
  };
  xhr.send('username=' + encodeURIComponent (username) + '&password=' + encodeURIComponent (password));
}



/*
 * Asking user to provide his username and password, before invoking login module.
 */
function logout () {

  /*
   *Creating and decorating our HTTP request.
   */
  var xhr = new XMLHttpRequest();
  xhr.open('DELETE', '/hyper-core/logout', true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {

      /*
       * Checking if this was a success or not.
       */
      if (xhr.status != 200) {
        alert(xhr.responseText);
        return;
      }

      eval("window.res = " + xhr.responseText);
      alert('Status; ' + window.res.status);
      window.location = window.location;
    }
  };
  xhr.send ();
}



/*
 * Function that populates "ul" element above, with the first 50 records from our database,
 * by invoking our "select" method.
 */
function get_items () {

  /*
   * Retrieves our above "ul" element, and creates an XHR object, to retrieve JSON data from the server.
   */
  var ul = document.getElementById ('names');
  var xhr = new XMLHttpRequest();

  /*
   * Retrieving first 50 items from our database, making sure we order them ascendingly.
   */
  xhr.open('GET', '/hyper-core/database/camphora/foo/select?[limit]=50', true);

  /*
   * Creating a "onfinished" callback for our XHR object.
   */
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {

      /*
       * Checking if this was a success or not.
       */
      if (xhr.status != 200) {
        alert(xhr.responseText);
        return;
      }

      /*
       * Deleting all old items from 'ul' element.
       */
      while (ul.firstChild) {
          ul.removeChild(ul.firstChild);
      }

      /*
       * Evaluating our JSON returned from server, and iterating through each item,
       * creating one "li" wrapper for each record.
       */
      eval("window.res = " + xhr.responseText);
      for (var idx = 0; idx < res.length; idx++) {

        // Creating new "li" element.
        var li = document.createElement('li');

        // Adding "span" element to show "name" from item.
        var span = document.createElement('span');
        span.innerHTML = res [idx].name;
        li.appendChild (span);

        // Creating a "delete" button.
        var del = document.createElement('button');
        del.style.cssText = "margin-left:15px;";
        del.onclick = function (event) {delete_item (event.target.getAttribute('data-value'));return false;};
        del.innerHTML = 'delete';
        del.setAttribute ("data-value", res [idx].id);
        li.appendChild (del);

        // Creating an "edit" button.
        var edit = document.createElement('button');
        edit.style.cssText = "margin-left:15px;";
        edit.onclick = function (event) {edit_item (event.target.getAttribute('data-value'));return false;};
        edit.innerHTML = 'edit';
        edit.setAttribute ("data-value", res [idx].id);
        li.appendChild (edit);

        // Appending main "li" element to "ul" element.
        ul.appendChild (li);
      }
    }
  };

  // Invoking our HTTP REST service.
  xhr.send();
}



/*
 * Asks user to provide a name, and invokes our server side HTTP REST database "insert" method.
 */
function insert_item () {

  /*
   * Asks user to provide us with a name.
   */
  var name = prompt('Enter some name', 'John Doe');

  /*
   * Creates our XHR object, which will invoke our "insert" method on the server side.
   */
  var xhr = new XMLHttpRequest();

  /*
   * Invoking our "insert" method, notice contrary to our "select" method, our
   * "insert" method requires us to use the HTTP PUT verb.
   */
  xhr.open('PUT', '/hyper-core/database/camphora/foo/insert', true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

  /*
   * Creating an "onfinished" callback for our XHR object.
   */
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {

      /*
       * Checking if this was a success or not.
       */
      if (xhr.status != 200) {
        alert(xhr.responseText);
        return;
      }

      /*
       * Doing some basic logging and re-databinding our "ul" element again.
       */
      eval("window.res = " + xhr.responseText);
      console.log('Item was successfully inserted with the id of; ' + window.res.id);
      get_items ();
    }
  };

  // Sending our body to server.
  var body = 'name=' + name;
  xhr.send(body);
}



/*
 * Asks user to provide a new name, and invokes our server side HTTP REST database "edit" method.
 */
function edit_item (id) {

  /*
   * Asks user to provide us with a name.
   */
  var name = prompt('Enter some new name for your item', 'John Doe');

  /*
   * Creates our XHR object, which will invoke our "insert" method on the server side.
   */
  var xhr = new XMLHttpRequest();

  /*
   * Invoking our "insert" method, notice contrary to our "select" method, our
   * "insert" method requires us to use the HTTP PUT verb.
   */
  xhr.open('POST', '/hyper-core/database/camphora/foo/update?id=' + id, true);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

  /*
   * Creating an "onfinished" callback for our XHR object.
   */
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {

      /*
       * Checking if this was a success or not.
       */
      if (xhr.status != 200) {
        alert(xhr.responseText);
        return;
      }

      /*
       * Doing some basic logging and re-databinding our "ul" element again.
       */
      eval("window.res = " + xhr.responseText);
      console.log('Item was successfully updated, affected records was; ' + window.res.affected_records);
      get_items ();
    }
  };

  // Sending our body to server.
  var body = 'name=' + name;
  xhr.send(body);
}



/*
 * Asks user to provide a name, and invokes our server side HTTP REST database "insert" method.
 */
function delete_item (id) {

  /*
   * Creates our XHR object, which will invoke our "insert" method on the server side.
   */
  var xhr = new XMLHttpRequest();

  /*
   * Invoking our "insert" method, notice contrary to our "select" method, our
   * "insert" method requires us to use the HTTP POST verb.
   */
  xhr.open('DELETE', '/hyper-core/database/camphora/foo/delete?id=' + id, true);

  /*
   * Creating a "onfinished" callback for our XHR object.
   */
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {

      /*
       * Checking if this was a success or not.
       */
      if (xhr.status != 200) {
        alert(xhr.responseText);
        return;
      }

      /*
       * Doing some basic logging, and re-databinding our "ul" items again.
       */
      eval("window.res = " + xhr.responseText);
      console.log('Item was successfully deleted');
      get_items ();
    }
  };

  // Invoking our HTTP REST service.
  xhr.send();
}



/*
 * Populates "ul" element above, using our HTTP REST "select" wrapper function created above.
 */
get_items();

    </script>
  </body>
</html>
